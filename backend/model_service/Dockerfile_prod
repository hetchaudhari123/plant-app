# ---- Stage 1: Build wheels ----
FROM python:3.11.2-slim AS builder

WORKDIR /app

# Configure pip timeout
ENV PIP_DEFAULT_TIMEOUT=900

# Copy requirements
COPY requirements.txt .

# Upgrade pip + build wheels
RUN pip install --upgrade pip setuptools wheel

# Install CPU-only PyTorch wheels separately
RUN pip wheel --no-cache-dir \
    --wheel-dir /wheels \
    torch==2.3.0+cpu torchvision==0.18.0+cpu torchaudio==2.3.0+cpu \
    --index-url https://download.pytorch.org/whl/cpu

# ---- Filter requirements.txt to exclude torch packages ----
RUN grep -vE "torch==|torchaudio==|torchvision==" requirements.txt > requirements-no-torch.txt

# ---- Build wheels for the rest of the requirements ----
RUN pip wheel --no-cache-dir --wheel-dir /wheels -r requirements-no-torch.txt

# ---- Stage 2: Final image ----
FROM python:3.11.2-slim

WORKDIR /app

ENV PIP_DEFAULT_TIMEOUT=900

# Install runtime deps
RUN apt-get update && \
    apt-get install -y --no-install-recommends curl && \
    rm -rf /var/lib/apt/lists/*

# Copy wheels from builder and install them
COPY --from=builder /wheels /wheels
RUN pip install --no-cache-dir /wheels/* \
    && pip install --no-cache-dir gunicorn uvicorn

# Copy application code
COPY . .

# Expose port
EXPOSE 8002

# Run the app
CMD ["gunicorn", "-k", "uvicorn.workers.UvicornWorker", "main:app", "--bind", "0.0.0.0:8002", "--workers", "4"]
